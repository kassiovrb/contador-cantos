<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contador de Cantos</title>

<style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden;
    background: #f2f2f2;
}
#areaCronometro{
    display:flex;
    justify-content:flex-end; 
    align-items:center;
    gap:40px; 
    padding-right:50px; 
    margin-top: 25px;
}

#ladoTempo{
    display:flex;
    flex-direction:column;
    align-items:center;
}

#botoesTempo{
    display:flex;
    flex-direction:column;
    gap:10px;
}

.btnTempoAcao{
    width:90px;
    height:45px;
    border:none;
    border-radius:10px;
    background:#1a2020;
    color:rgb(252, 249, 249);
    font-weight:bold;
    cursor:pointer;
}

#app {
    width: 390px;
    height: 844px;
    transform-origin: top left;
    background: #f2f2f2;
    font-family: Arial, sans-serif;
    padding: 10px;
    box-sizing: border-box;
}

#topo {
    text-align: center;
}

#tempo {
    font-size: 60px;
    font-weight: bold;
}

#controleTempo {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 6px;
}

.btnTempo {
    font-size: 24px;
    padding: 5px 12px;
}

#previsao {
    margin-top: 10px;
    font-size: 20px;
    font-weight: bold;
    text-align:left;      
    padding-left:140px;   
}


#conteudo {
    margin-top: 20px;
}

#minutos {
    font-size: 16px;
    padding-right: 190px;
}

#contador {
    position: fixed;
    top: 250px;
    right: 25px;
    width: 170px;
    text-align: center;
    z-index: 10;
}

#labelCantos {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 6px;
}

#total {
    font-size: 72px;
    font-weight: bold;
    background: #FFD700;
    color: #000;
    width: 160px;
    height: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: background 0.1s ease;
}

.piscar {
    background: #FF3B3B !important;
}

#botoes {
    position: fixed;
    bottom: 28px;
    left: 0;
    width: 100%;
    text-align: center;
}

#btnContar {
    width: calc(95% + 115px);
    height: 270px;
    font-size: 70px;
    background: green;
    color: white;
    border: none;
    border-radius: 18px;
}

#btnsPequenos {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap; 
}

.btnSmall {
    font-size: 16px;
    padding: 8px 14px;
    background: #F5E6C8;   
    color: #000;
    border: 1px solid #D8C9A6;
    border-radius: 8px;
}
.modal{
    position: fixed;
    inset:0;
    background: rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
}

.modalBox{
    background:white;
    padding:20px;
    border-radius:14px;
    width:80%;
    max-width:300px;
    text-align:center;
    max-height:70vh;
    overflow-y:auto;
}

.modal input{
    width:90%;
    padding:8px;
    font-size:16px;
}
</style>
</head>

<body>
<div id="app">

<div id="topo">

    <!-- Bot√µes pequenos agora ficam no topo -->
    <div id="btnsPequenos">
    <button class="btnSmall" onclick="pausar()">PAUSE</button>
    <button class="btnSmall" onclick="zerar()">ZERAR</button>
   </div>

   <div id="areaCronometro">

     <div id="botoesTempo">

        <button onclick="abrirSalvar()" class="btnTempoAcao">
             SALVAR CANTADA
        </button>

        <button onclick="verHistorico()" class="btnTempoAcao">
           CANTADAS SALVA
        </button>

    </div>
    <div id="ladoTempo">

        <div id="tempo">15:00</div>

        <div id="controleTempo">
            <button class="btnTempo" onclick="ajustarTempo(1)">‚ñ≤</button>
            <span id="tempoMin">15 min</span>
            <button class="btnTempo" onclick="ajustarTempo(-1)">‚ñº</button>
        </div>

    </div>


   

</div>

    <div id="previsao">Previs√£o: 0 cantos</div>
</div>

<div id="conteudo">
    <div id="minutos"></div>
</div>

<div id="contador">
    <div id="labelCantos">CANTOS</div>
    <div id="total">0</div>
</div>

<div id="botoes">
    <button id="btnContar" onclick="contar()">CONTAR</button>
</div>

</div>

<!-- MODAL SALVAR -->
<div id="modalSalvar" class="modal">
    <div class="modalBox">
        <h3>Nome da ave</h3>
        <input id="nomeAve" placeholder="Ex: Trinca Ferro do Jo√£o"/>
        <br><br>
        <button onclick="confirmarSalvar()">SALVAR</button>
        <button onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<!-- MODAL HISTORICO -->
<div id="modalHistorico" class="modal">
    <div class="modalBox">
        <h3>Hist√≥rico</h3>
        <div id="listaHistorico"></div>
        <br>
        <button onclick="fecharHistorico()">Fechar</button>
    </div>
</div>


<script>

    function abrirSalvar(){
    document.getElementById("modalSalvar").style.display="flex";
}
function fecharModal(){
    document.getElementById("modalSalvar").style.display="none";
}

function finalizarContagem(){

    // Se ainda n√£o salvou o √∫ltimo minuto
    if(cantosMinutoAtual >= 0){

        numeroMinuto++;

        document.getElementById("minutos").innerHTML +=
            `<div>${numeroMinuto}¬∫ minuto: ${cantosMinutoAtual} cantos</div>`;
    }

}

function confirmarSalvar(){

    const nome = document.getElementById("nomeAve").value.trim();

    if(!nome){
        alert("Digite o nome da ave");
        return;
    }

    const data = new Date().toLocaleDateString("pt-BR");

    const minutos = Math.floor((tempoTotal - tempoRestante)/60);
    const segundos = (tempoTotal - tempoRestante)%60;

    const tempoRodado =
        String(minutos).padStart(2,"0")+":"+
        String(segundos).padStart(2,"0");

    const registro = {
        nome,
        data,
        tempo: tempoRodado,
        cantos: totalCantos
    };

    let historico =
        JSON.parse(localStorage.getItem("historicoCantos")) || [];

    historico.unshift(registro);

    localStorage.setItem(
        "historicoCantos",
        JSON.stringify(historico)
    );

    fecharModal();
    document.getElementById("nomeAve").value="";
}

function verHistorico(){

    const lista = document.getElementById("listaHistorico");
    lista.innerHTML="";

    let historico =
        JSON.parse(localStorage.getItem("historicoCantos")) || [];

    if(historico.length===0){
        lista.innerHTML="<p>Nenhuma cantada salva.</p>";
    }else{

       historico.forEach((item,index)=>{
           lista.innerHTML += `
    <div style="
        border-bottom:1px solid #ddd;
        padding:8px;
        text-align:left;
        position:relative;
    ">

    <button onclick="excluirCantada(${index})"
        style="
            position:absolute;
            right:5px;
            top:5px;
            border:none;
            background:#ff4d4d;
            color:white;
            border-radius:6px;
            padding:4px 6px;
            font-size:12px;
            cursor:pointer;
        ">
        excluir cantadaüóëÔ∏è
    </button>

    üê¶ <b>${item.nome}</b><br>
    üìÖ ${item.data}<br>
    ‚è±Ô∏è ${item.tempo}<br>
    üîä ${item.cantos} cantos
    </div>
`;
        });
    }

    document.getElementById("modalHistorico").style.display="flex";
}

function fecharHistorico(){
    document.getElementById("modalHistorico").style.display="none";
}

function excluirCantada(index){

    if(!confirm("Excluir esta cantada?"))
        return;

    let historico =
        JSON.parse(localStorage.getItem("historicoCantos")) || [];

    historico.splice(index,1);

    localStorage.setItem(
        "historicoCantos",
        JSON.stringify(historico)
    );

    verHistorico(); // recarrega a lista
}

function ajustarEscala() {
    const baseW = 390;
    const baseH = 844;

    const scaleX = window.innerWidth / baseW;
    const scaleY = window.innerHeight / baseH;
    const scale = Math.min(scaleX, scaleY);

    const app = document.getElementById("app");
    app.style.transform = `scale(${scale})`;
}

window.addEventListener("resize", ajustarEscala);
ajustarEscala();

let tempoTotal = 15 * 60;
let tempoRestante = tempoTotal;
let intervalo = null;
let previsaoIntervalo = null;

let totalCantos = 0;
let pausado = false;

let inicio = null;
let inicioMinuto = null;
let cantosMinutoAtual = 0;
let numeroMinuto = 0;

let somAtivo = true;
let audioCtx = null;

function tocarSom() {
    if (!somAtivo) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "square";
    osc.frequency.value = 500;
    gain.gain.value = 0.1;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start();
    setTimeout(() => osc.stop(), 50);
}

function toggleSom() {
    somAtivo = !somAtivo;
    document.getElementById("btnSom").innerText = somAtivo ? "Som: ON" : "Som: OFF";
}

function atualizarTela() {
    let min = Math.floor(tempoRestante / 60);
    let seg = tempoRestante % 60;
    document.getElementById("tempo").innerText =
        String(min).padStart(2, "0") + ":" + String(seg).padStart(2, "0");
}

function ajustarTempo(valor) {
    if (intervalo) return;
    let minutos = tempoTotal / 60 + valor;
    if (minutos < 1) return;
    tempoTotal = minutos * 60;
    tempoRestante = tempoTotal;
    document.getElementById("tempoMin").innerText = minutos + " min";
    atualizarTela();
}

function iniciarTimer() {
    inicio = Date.now();
    inicioMinuto = inicio;

    intervalo = setInterval(() => {
        if (!pausado) {
            tempoRestante--;
            atualizarTela();
            verificarMinuto();

            if (tempoRestante <= 0) {

    finalizarContagem(); 

    clearInterval(intervalo);
    clearInterval(previsaoIntervalo);
}

        }
    }, 1000);

    previsaoIntervalo = setInterval(atualizarPrevisao, 3000);
}

function contar() {
    manterTelaAtiva();

    if (!intervalo) {
        iniciarTimer();
        return;
    }

    tocarSom();
    if (navigator.vibrate) navigator.vibrate(50);

    totalCantos++;
    cantosMinutoAtual++;

    const totalEl = document.getElementById("total");
    totalEl.innerText = totalCantos;
    totalEl.classList.add("piscar");
    setTimeout(() => totalEl.classList.remove("piscar"), 120);
}

function verificarMinuto() {
    let agora = Date.now();
    if (Math.floor((agora - inicioMinuto) / 60000) >= 1) {
        numeroMinuto++;
        document.getElementById("minutos").innerHTML +=
            `<div>${numeroMinuto}¬∫ minuto: ${cantosMinutoAtual} cantos</div>`;
        cantosMinutoAtual = 0;
        inicioMinuto = agora;
    }
}

function atualizarPrevisao() {
    if (!inicio) return;
    let tempoDecorrido = (Date.now() - inicio) / 1000;
    let previsao = Math.round((totalCantos / tempoDecorrido) * tempoTotal);
    document.getElementById("previsao").innerText =
        "Previs√£o: " + previsao + " cantos";
}

function pausar() {
    pausado = !pausado;
}

function zerar() {
    clearInterval(intervalo);
    clearInterval(previsaoIntervalo);

    intervalo = null;
    previsaoIntervalo = null;

    tempoRestante = tempoTotal;
    totalCantos = 0;
    pausado = false;
    inicio = null;
    inicioMinuto = null;
    cantosMinutoAtual = 0;
    numeroMinuto = 0;

    document.getElementById("total").innerText = "0";
    document.getElementById("minutos").innerHTML = "";
    document.getElementById("previsao").innerText = "Previs√£o: 0 cantos";

    atualizarTela();
}

atualizarTela();

/* üîí Wake Lock */
let wakeLock = null;

async function manterTelaAtiva() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {}
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        manterTelaAtiva();
    }
});

/* üì¶ OFFLINE ‚Äì registra o Service Worker */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>



